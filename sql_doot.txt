CREATE DATABASE doot DEFAULT CHARACTER SET utf8;

USE doot; 

GRANT ALL ON doot.* TO 'doot'@'localhost' IDENTIFIED BY 'doot';

//user table

CREATE TABLE users(
   user_id INTEGER NOT NULL AUTO_INCREMENT PRIMARY KEY,
   email VARCHAR(128) UNIQUE NOT NULL,
   username VARCHAR(128) UNIQUE NOT NULL,
   password VARCHAR(128) NOT NULL,
   user_join_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
   dhan INTEGER UNSIGNED NOT NULL DEFAULT 1000
   verified bit NOT NULL,
   INDEX(email),
   INDEX(username)
) ENGINE=InnoDB CHARSET=utf8;

ALTER TABLE users ADD name VARCHAR(128) , ADD dob DATE , ADD image_url VARCHAR(1024) DEFAULT "random_image/art16.jpg";

CREATE TABLE user_add_data (
   user_id INTEGER,
   name VARCHAR(128) NOT NULL,
   dob DATE NOT NULL,
   image_url VARCHAR(1024),
   CONSTRAINT FOREIGN KEY (user_id)
   REFERENCES users(user_id) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB CHARSET=utf8;

CREATE TABLE grps(
   grp_id INTEGER NOT NULL AUTO_INCREMENT PRIMARY KEY,
   grpname VARCHAR(128) UNIQUE NOT NULL,
   creator_id INTEGER NOT NULL,
   grp_create_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
   INDEX(grp_id),
   INDEX(creator_id),
   CONSTRAINT FOREIGN KEY (creator_id)
   REFERENCES users(user_id) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB CHARSET=utf8;



CREATE TABLE post_data (
   post_id INTEGER PRIMARY KEY NOT NULL AUTO_INCREMENT,
   origin_id INTEGER NOT NULL,
   post_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
   content_type VARCHAR(1) NOT NULL,
   heading VARCHAR(256) NOT NULL,
   content VARCHAR(2048) NOT NULL,
   num_likes SMALLINT NOT NULL,
   num_comment SMALLINT UNSIGNED NOT NULL,
   num_reblog SMALLINT UNSIGNED NOT NULL,
   where_id INTEGER NOT NULL,
   CONSTRAINT FOREIGN KEY (origin_id)
   REFERENCES users(user_id) ON DELETE CASCADE ON UPDATE CASCADE,
   CONSTRAINT FOREIGN KEY (where_id)
   REFERENCES grps(grp_id) ON DELETE CASCADE ON UPDATE CASCADE
    )ENGINE=InnoDB CHARSET=utf8;


CREATE TABLE grp_user_rel(
grp_id INTEGER NOT NULL,
user_id INTEGER NOT NULL,
relation VARCHAR(1) NOT NULL,
relation_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
CONSTRAINT FOREIGN KEY (user_id)
REFERENCES users(user_id) ON DELETE CASCADE ON UPDATE CASCADE,
CONSTRAINT FOREIGN KEY (grp_id)
REFERENCES grps(grp_id) ON DELETE CASCADE ON UPDATE CASCADE  
)ENGINE=InnoDB CHARSET=utf8;

ALTER TABLE grp_user_rel
   ADD PRIMARY KEY (grp_id, user_id);

CREATE TABLE user_user_rel(
user1_id INTEGER NOT NULL,
user2_id INTEGER NOT NULL,
relation VARCHAR(1) NOT NULL,
relation_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
CONSTRAINT FOREIGN KEY (user1_id)
REFERENCES users(user_id) ON DELETE CASCADE ON UPDATE CASCADE,
CONSTRAINT FOREIGN KEY (user2_id)
REFERENCES users(user_id) ON DELETE CASCADE ON UPDATE CASCADE  
)ENGINE=InnoDB CHARSET=utf8;

ALTER TABLE user_user_rel
   ADD PRIMARY KEY (user1_id, user2_id);

CREATE TABLE comment_data (
   comment_id INTEGER PRIMARY KEY NOT NULL AUTO_INCREMENT,
   origin_id INTEGER NOT NULL,
   post_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
   content VARCHAR(2048) NOT NULL,
   num_likes SMALLINT NOT NULL,
   parent_comment_id INTEGER NOT NULL,
   post_id INTEGER,
   CONSTRAINT FOREIGN KEY (origin_id)
   REFERENCES users(user_id) ON DELETE CASCADE ON UPDATE CASCADE,
   CONSTRAINT FOREIGN KEY (post_id)
   REFERENCES post_data(post_id) ON DELETE CASCADE ON UPDATE CASCADE
    )ENGINE=InnoDB CHARSET=utf8;



CREATE TABLE chat(
user1_id INTEGER NOT NULL,
user2_id INTEGER NOT NULL,
last_message VARCHAR(512) NOT NULL,
message_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
PRIMARY KEY (user1_id, user2_id),
CONSTRAINT FOREIGN KEY (user1_id)
REFERENCES users(user_id) ON DELETE CASCADE ON UPDATE CASCADE,
CONSTRAINT FOREIGN KEY (user2_id)
REFERENCES users(user_id) ON DELETE CASCADE ON UPDATE CASCADE  
)ENGINE=InnoDB CHARSET=utf8;

CREATE TABLE chat_request(
user1_id INTEGER NOT NULL,
user2_id INTEGER NOT NULL,
last_message VARCHAR(512) NOT NULL,
message_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
PRIMARY KEY (user1_id, user2_id),
CONSTRAINT FOREIGN KEY (user1_id)
REFERENCES users(user_id) ON DELETE CASCADE ON UPDATE CASCADE,
CONSTRAINT FOREIGN KEY (user2_id)
REFERENCES users(user_id) ON DELETE CASCADE ON UPDATE CASCADE  
)ENGINE=InnoDB CHARSET=utf8;
        
CREATE TABLE notification(
    notify_id INTEGER NOT NULL AUTO_INCREMENT PRIMARY KEY,
     user1_id INTEGER NOT NULL, user2_id INTEGER NOT NULL,
      notification VARCHAR(512) NOT NULL,
       notify_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
        CONSTRAINT FOREIGN KEY (user1_id)
         REFERENCES users(user_id) ON DELETE CASCADE ON UPDATE CASCADE,
          CONSTRAINT FOREIGN KEY (user2_id)
           REFERENCES users(user_id) ON DELETE CASCADE ON UPDATE CASCADE 
           )ENGINE=InnoDB CHARSET=utf8


ALTER TABLE users 
ADD num_friend INTEGER DEFAULT 1,
ADD    num_follower INTEGER DEFAULT 0,
ADD    num_following INTEGER DEFAULT 0,
   ADD num_post INTEGER DEFAULT 0,
 ADD   num_comment INTEGER DEFAULT 0,
   ADD num_post_like INTEGER DEFAULT 0,
   ADD num_comment_like INTEGER DEFAULT 0


   CREATE TABLE post_vote (
    post_id INTEGER,
    user_id INTEGER,
    vote VARCHAR(1),
    PRIMARY KEY(post_id, user_id),
   CONSTRAINT FOREIGN KEY (user_id)
   REFERENCES users(user_id) ON DELETE CASCADE ON UPDATE CASCADE,
   CONSTRAINT FOREIGN KEY (post_id)
   REFERENCES post_data(post_id) ON DELETE CASCADE ON UPDATE CASCADE
    )ENGINE=InnoDB CHARSET=utf8;

    CREATE TABLE post_comment(
    comment_id INTEGER AUTO_INCREMENT PRIMARY KEY NOT NULL,
    post_id INTEGER,
    user_id INTEGER,
    comment_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    content VARCHAR(1024) NOT NULL,
    CONSTRAINT FOREIGN KEY (user_id)
    REFERENCES users(user_id) ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT FOREIGN KEY (post_id)
    REFERENCES post_data(post_id) ON DELETE CASCADE ON UPDATE CASCADE)
    ENGINE=InnoDB CHARSET=utf8

    CREATE TABLE inbox(
    inbox_id INTEGER NOT NULL AUTO_INCREMENT PRIMARY KEY,
     user_id INTEGER NOT NULL,
      inbox VARCHAR(512) NOT NULL,
       inbox_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
        CONSTRAINT FOREIGN KEY (user_id)
         REFERENCES users(user_id) ON DELETE CASCADE ON UPDATE CASCADE
      
           )ENGINE=InnoDB CHARSET=utf8


           ALTER TABLE grps ADD grp_des VARCHAR (128) DEFAULT "Welcome to the group";

// remove this wallet
CREATE TABLE wallet (
wallet_id INTEGER PRIMARY KEY AUTO_INCREMENT NOT NULL,
    user_id INTEGER,
    dhan INTEGER UNSIGNED NOT NULL DEFAULT 1000,
    CONSTRAINT FOREIGN KEY (user_id)
   REFERENCES users(user_id) ON DELETE CASCADE ON UPDATE CASCADE 
)ENGINE=InnoDB CHARSET=utf8;

ALTER TABLE post_data ADD owner_id INTEGER NOT NULL;
Update post_data SET owner_id =origin_id Where owner_id = 0;
ALTER TABLE post_data ADD CONSTRAINT pd_owner  
FOREIGN KEY (owner_id) REFERENCES users(user_id) ON DELETE CASCADE ON UPDATE CASCADE;

CREATE TABLE ask_price (
ask_price_id INTEGER PRIMARY KEY AUTO_INCREMENT NOT NULL,
  post_id INTEGER,
  ask_price INTEGER UNSIGNED NOT NULL DEFAULT 100,
  CONSTRAINT FOREIGN KEY (post_id)
  REFERENCES post_data(post_id) ON DELETE CASCADE ON UPDATE CASCADE 
)ENGINE=InnoDB CHARSET=utf8;

CREATE TABLE bid_price (
bid_price_id INTEGER PRIMARY KEY AUTO_INCREMENT NOT NULL,
  post_id INTEGER,
   bidder_id INTEGER,
  bid_price_value INTEGER UNSIGNED NOT NULL,
  CONSTRAINT FOREIGN KEY (post_id)
  REFERENCES post_data(post_id) ON DELETE CASCADE ON UPDATE CASCADE,
      CONSTRAINT FOREIGN KEY (bidder_id)
  REFERENCES users(user_id) ON DELETE CASCADE ON UPDATE CASCADE
)ENGINE=InnoDB CHARSET=utf8;


CREATE TABLE transact (
transact_id INTEGER PRIMARY KEY AUTO_INCREMENT NOT NULL,
buyer_id INTEGER,
seller_id INTEGER,
price INTEGER UNSIGNED NOT NULL,
post_id INTEGER,
  CONSTRAINT FOREIGN KEY (buyer_id)
  REFERENCES users(user_id) ON DELETE CASCADE ON UPDATE CASCADE,
      CONSTRAINT FOREIGN KEY (seller_id)
  REFERENCES users(user_id) ON DELETE CASCADE ON UPDATE CASCADE,
          CONSTRAINT FOREIGN KEY (post_id)
  REFERENCES post_data(post_id) ON DELETE CASCADE ON UPDATE CASCADE
)ENGINE=InnoDB CHARSET=utf8;


ALTER TABLE transact ADD transact_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP;
ALTER TABLE ask_price ADD ask_price_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP;
ALTER TABLE bid_price ADD bid_price_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP;

ALTER TABLE `users` CHANGE `num_friend` `num_friend` INT(11) NULL DEFAULT '1';

